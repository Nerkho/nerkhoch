<!DOCTYPE html>
<html lang="en-GB">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  <meta http-equiv="X-Clacks-Overhead" content="GNU Terry Pratchett" />
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="shortcut icon" href="http://localhost:1313/images/favicon.png" />
<title>Homelab Kubernetes cluster with Talos, Matchbox and Cilium | nerkho</title>
<meta name="title" content="Homelab Kubernetes cluster with Talos, Matchbox and Cilium" />
<meta name="description" content="Intro Some time ago, I deployed a Kubernetes cluster as a homelab for running some workload and testing some stuff. Back then, I used Unbutu server with straight kubeadm to bootstrap the nodes. While it was working, it was not really fun to maintain the OS layer.
Then I came accros Talos and started using that as the underlying Linux distro on my nodes. My first experience with Talos was the good old : download the boot assets, write them to a USB key and go from there." />
<meta name="author" content="" />
<meta name="keywords" content="kubernetes,talos,cilium,homelab," />






  





  













<meta property="og:title" content="Homelab Kubernetes cluster with Talos, Matchbox and Cilium" />
<meta property="og:description" content="Intro Some time ago, I deployed a Kubernetes cluster as a homelab for running some workload and testing some stuff. Back then, I used Unbutu server with straight kubeadm to bootstrap the nodes. While it was working, it was not really fun to maintain the OS layer.
Then I came accros Talos and started using that as the underlying Linux distro on my nodes. My first experience with Talos was the good old : download the boot assets, write them to a USB key and go from there." />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://localhost:1313/blog/homelab-k8s-talos-matchbox-cilium/" />

<meta property="og:image" content="http://localhost:1313/images/social_card_bg_hu24b6b25ef60ca259d3d1b88ebbfdfb28_6698_a466b1531860fdddb060aa1fac277dd0.webp"/><meta property="article:section" content="blog" />
<meta property="article:published_time" content="2024-11-16T00:00:00+00:00" />
<meta property="article:modified_time" content="2024-11-16T00:00:00+00:00" /><meta property="og:site_name" content="nerkho" />




<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="http://localhost:1313/images/social_card_bg_hu24b6b25ef60ca259d3d1b88ebbfdfb28_6698_a466b1531860fdddb060aa1fac277dd0.webp"/>
<meta name="twitter:title" content="Homelab Kubernetes cluster with Talos, Matchbox and Cilium"/>
<meta name="twitter:description" content="Intro Some time ago, I deployed a Kubernetes cluster as a homelab for running some workload and testing some stuff. Back then, I used Unbutu server with straight kubeadm to bootstrap the nodes. While it was working, it was not really fun to maintain the OS layer.
Then I came accros Talos and started using that as the underlying Linux distro on my nodes. My first experience with Talos was the good old : download the boot assets, write them to a USB key and go from there."/>



<meta itemprop="name" content="Homelab Kubernetes cluster with Talos, Matchbox and Cilium">
<meta itemprop="description" content="Intro Some time ago, I deployed a Kubernetes cluster as a homelab for running some workload and testing some stuff. Back then, I used Unbutu server with straight kubeadm to bootstrap the nodes. While it was working, it was not really fun to maintain the OS layer.
Then I came accros Talos and started using that as the underlying Linux distro on my nodes. My first experience with Talos was the good old : download the boot assets, write them to a USB key and go from there."><meta itemprop="datePublished" content="2024-11-16T00:00:00+00:00" />
<meta itemprop="dateModified" content="2024-11-16T00:00:00+00:00" />
<meta itemprop="wordCount" content="2026">

<meta itemprop="image" content="http://localhost:1313/images/social_card_bg_hu24b6b25ef60ca259d3d1b88ebbfdfb28_6698_a466b1531860fdddb060aa1fac277dd0.webp"/>


<meta itemprop="keywords" content="kubernetes,talos,cilium,homelab," />

<meta name="referrer" content="no-referrer-when-downgrade" />

  
  <link href="/original.min.css" rel="stylesheet">

  
    
    <link href="/syntax.min.css" rel="stylesheet">
  

  

  
</head>

<body>
  <header><a class="skip-link" href="#main-content">Skip to main content</a>

<a href="/" class="title"><h1>nerkho</h1></a>
<nav>
  <a href="/">Home</a>

  <a href="/blog/">Blog</a>

  <a href="/_tools/">Tools</a>

<a href='http://localhost:1313/index.xml'>RSS</a>







  
    
    
      <a class="disabled" role="link" aria-disabled="true">FR ðŸ‡«ðŸ‡·</a>
    
  

  
    
    
      <a class="disabled" role="link" aria-disabled="true"></a>
    
  

</nav>
</header>
  <main id="main-content">

<h1>Homelab Kubernetes cluster with Talos, Matchbox and Cilium</h1>
<p class="byline">
  <time datetime='2024-11-16' pubdate>
    2024-11-16
  </time>
  
</p>

<content>
  <h2 id="intro">Intro</h2>
<p>Some time ago, I deployed a Kubernetes cluster as a homelab for running some workload and testing some stuff. Back then, I used Unbutu server with straight <code>kubeadm</code> to bootstrap the nodes. While it was working, it was not really fun to maintain the OS layer.</p>
<p>Then I came accros <a href="https://www.talos.dev/">Talos</a> and started using that as the underlying Linux distro on my nodes. My first experience with Talos was the good old : download the boot assets, write them to a USB key and go from there.</p>
<p>Recently, I decided to improve this setup and make the nodes deploy in an automated fashion via iPXE. This write up covers the steps to get there.</p>
<ul>
<li>
<p><a href="https://www.talos.dev/">Talos</a>: Talos Linux is a distribution dedicated to running Kubernetes. It can be deployed almost anywhere, which makes it an excellent choice for a homelab. By default, it contains only what is necessary to run Kubernetes. It doesn&rsquo;t provide a terminal access, everything goes through an API. It&rsquo;s also quite straightforward to manage and upgrade.</p>
</li>
<li>
<p><a href="https://matchbox.psdn.io/">Matchbox</a>: Although you could simply use a USB stick and <code>talosctl</code> to configure Talos nodes, I decided to deploy and bootstrap my nodes via iPXE. Matchbox will help in that regards by using the correct confugration file (control plane vs. worker node) depending on the MAC address.</p>
</li>
<li>
<p><a href="https://cilium.io/">Cilium</a>: Cilium is my cluster CNI. Aside from the networking capabilities, it can also provide <a href="https://docs.cilium.io/en/stable/network/lb-ipam/">LB IPAM</a> capabilities instead of deploying an additional tool like <a href="https://metallb.universe.tf/">MetalLB</a>.</p>
</li>
</ul>
<h3 id="sources">Sources</h3>
<p>A lot of what is detailed below has been sourced from different places :</p>
<ul>
<li><a href="https://www.talos.dev/v1.7/introduction/">Talos documentation</a></li>
<li><a href="https://matchbox.psdn.io/">Matchbox documentation</a></li>
<li><a href="https://docs.cilium.io/en/stable/">Cilium documentation</a></li>
</ul>
<h2 id="preparation">Preparation</h2>
<h3 id="matchbox-networking-pre-quisite">Matchbox networking pre-quisite</h3>
<p>As I&rsquo;m using a Raspberry PI with <a href="https://pi-hole.net/">Pi-hole</a> as my DHCP server, I will skip <code>dnsmasq</code> general installation and configuration and just focus on what&rsquo;s needed to make it uses Matchbox as the PXE service.</p>
<p>Create an additionnal config file in <code>/etc/dnsmasq.d</code> folder&hellip;</p>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">vim /etc/dnsmasq.d/07-tftp-server.conf</span></span></code></pre></div><p>&hellip;and add the following.</p>





<pre tabindex="0"><code>enable-tftp
tftp-root=/var/lib/tftpboot
dhcp-userclass=set:ipxe,iPXE
pxe-service=tag:#ipxe,x86PC,&#34;PXE chainload to iPXE&#34;,undionly.kpxe
pxe-service=tag:ipxe,x86PC,&#34;iPXE&#34;,http://matchbox.lan:8080/boot.ipxe #Make sure the hostname point to the machine matchbox is deployed to</code></pre><p>You will probably need to restart <code>dnsmasq</code> service.</p>
<p>Next add <a href="http://boot.ipxe.org/undionly.kpxe">http://boot.ipxe.org/undionly.kpxe</a> to the <code>tftp-root</code>. (in this case <code>/var/lib/tftpboot</code>)</p>
<h3 id="matchbox-installation">Matchbox installation</h3>
<p>Download the <a href="https://github.com/poseidon/matchbox/releases">latest Matchbox release</a>. As I&rsquo;m running Matchbox on a RPI, I&rsquo;m using the ARM64 release below. Make sure to use the one that matches your architecture.</p>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl"><span class="c1">#Download latest release</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl">wget https://github.com/poseidon/matchbox/releases/download/v0.11.0/matchbox-v0.11.0-linux-arm64.tar.gz
</span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="c1">#Verify signature</span>
</span></span><span class="line"><span class="ln">4</span><span class="cl">gpg --keyserver keyserver.ubuntu.com --recv-key 2E3D92BF07D9DDCCB3BAE4A48F515AD1602065C8
</span></span><span class="line"><span class="ln">5</span><span class="cl">gpg --verify matchbox-v0.11.0-linux-arm64.tar.gz.asc matchbox-v0.11.0-linux-arm64.tar.gz
</span></span><span class="line"><span class="ln">6</span><span class="cl"><span class="c1">#Untar</span>
</span></span><span class="line"><span class="ln">7</span><span class="cl">tar xzvf matchbox-v0.10.0-linux-arm64.tar.gz</span></span></code></pre></div><p>Copy the binary to an appropriate location in your $PATH`</p>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">sudo cp matchbox /usr/local/bin</span></span></code></pre></div><p>Create a dedicated user for the matchbox service.</p>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">sudo useradd -U matchbox
</span></span><span class="line"><span class="ln">2</span><span class="cl">sudo mkdir -p /var/lib/matchbox/assets
</span></span><span class="line"><span class="ln">3</span><span class="cl">sudo chown -R matchbox:matchbox /var/lib/matchbox</span></span></code></pre></div><p>Copy the provided Matchbox systemd unit file.</p>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">sudo cp contrib/systemd/matchbox.service /etc/systemd/system/matchbox.service</span></span></code></pre></div><p>Now edit the systemd service&hellip;</p>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">sudo systemctl edit matchbox</span></span></code></pre></div><p>&hellip;and enable the gRPC API. This is needed as later we will be using <a href="https://opentofu.org/">OpenTofu</a> to configure the Matchbox profiles for the Talos nodes. If you don&rsquo;t intend to use OpenTofu for this and configure the Matchbox profiles by other means, you can also leave it as is.</p>





<pre tabindex="0"><code>[Service]
Environment=&#34;MATCHBOX_ADDRESS=0.0.0.0:8080&#34;
Environment=&#34;MATCHBOX_LOG_LEVEL=debug&#34;
Environment=&#34;MATCHBOX_RPC_ADDRESS=0.0.0.0:8081&#34;</code></pre><p>Eventually, start and enable the service.</p>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">sudo systemctl daemon-reload
</span></span><span class="line"><span class="ln">2</span><span class="cl">sudo systemctl start matchbox
</span></span><span class="line"><span class="ln">3</span><span class="cl">sudo systemctl <span class="nb">enable</span> matchbox</span></span></code></pre></div><h3 id="talos-configuration-files">Talos configuration files</h3>
<p>Now you need to generate the Talos configuration files for our machines.</p>
<p><code>192.168.1.50</code> is a Virtual IP that will be shared by the controlplane nodes. It will serve as the main API address for Kubernetes.</p>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">talosctl gen config talos-k8s-metal-tutorial https://192.168.1.50:6443
</span></span><span class="line"><span class="ln">2</span><span class="cl">created controlplane.yaml
</span></span><span class="line"><span class="ln">3</span><span class="cl">created worker.yaml
</span></span><span class="line"><span class="ln">4</span><span class="cl">created talosconfig</span></span></code></pre></div><p>In <code>controlplane.yaml</code>, add the VIP that will be shared between the controlplane nodes.</p>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nn">...</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="nt">machine</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">  </span><span class="nt">network</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">    </span><span class="c"># `interfaces` is used to define the network interface configuration.</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">    </span><span class="nt">interfaces</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">        </span>- <span class="nt">interface</span><span class="p">:</span><span class="w"> </span><span class="l">eno1</span><span class="w"> </span><span class="c"># The interface name.</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">          </span><span class="nt">dhcp</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="c"># Indicates if DHCP should be used to configure the interface.</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">          </span><span class="c"># Virtual (shared) IP address configuration.</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">          </span><span class="nt">vip</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">            </span><span class="nt">ip</span><span class="p">:</span><span class="w"> </span><span class="m">192.168.1.50</span><span class="w"> </span><span class="c"># Specifies the IP address to be used.</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w"></span><span class="nn">...</span></span></span></code></pre></div><p>As I am using <a href="https://longhorn.io">Longhorn</a> to provide local block storage to my workloads, I will aso add the following to both <code>workload.yaml</code> and <code>controlplane.yaml</code> files. If you don&rsquo;t need Longhorn, you can skip this step.</p>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="nn">...</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="w"></span><span class="nt">machine</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="w">  </span><span class="nt">kubelet</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="w">    </span><span class="nt">extraMounts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="w">      </span>- <span class="nt">destination</span><span class="p">:</span><span class="w"> </span><span class="l">/var/lib/longhorn</span><span class="w"> </span><span class="c"># Destination is the absolute path where the mount will be placed in the container.</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">bind</span><span class="w"> </span><span class="c"># Type specifies the mount kind.</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="w">        </span><span class="nt">source</span><span class="p">:</span><span class="w"> </span><span class="l">/var/lib/longhorn</span><span class="w"> </span><span class="c"># Source specifies the source path of the mount.</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="w">        </span><span class="c"># Options are fstab style mount options.</span><span class="w">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="w">        </span><span class="nt">options</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="w">          </span>- <span class="l">bind</span><span class="w">
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="w">          </span>- <span class="l">rshared</span><span class="w">
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="w">          </span>- <span class="l">rw</span><span class="w">
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="w"></span><span class="nn">...</span></span></span></code></pre></div><p>I will also change the default installer, as Longhorn requires some specific <a href="https://www.talos.dev/v1.8/talos-guides/configuration/system-extensions/">system extensions</a> to function. For this, I use <a href="https://factory.talos.dev">Talos Linux Image Factory</a> to generate a schematic ID.</p>
<p><img alt="talos-factory" src="/img/homelab-k8s-talos-factory.png"></p>
<p>The schematic ID is then used to replace the default installer in both <code>workload.yaml</code> and <code>controlplane.yaml</code> files.</p>
<p>Note that depending on your hardware configuration, you may also need to change the <code>diskSelector</code>. This will pick any device that is plugged in and has 500GB or more. You can also directly <a href="https://www.talos.dev/v1.8/reference/configuration/v1alpha1/config/#Config.machine.install">specify the device</a>.</p>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln">1</span><span class="cl"><span class="nt">machine</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w">  </span><span class="nt">install</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w">    </span><span class="nt">diskSelector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="w">        </span><span class="nt">size</span><span class="p">:</span><span class="w"> </span><span class="s1">&#39;&gt;= 500GB&#39;</span><span class="w"> </span><span class="c"># Disk size.</span><span class="w">
</span></span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">factory.talos.dev/installer/613e1592b2da41ae5e265e8789429f22e121aab91cb4deb6bc3c0b6262961245:v1.8.2</span></span></span></code></pre></div><p>Last thing, I&rsquo;m going to disable <code>kube-proxy</code> as I will be replacing it with Cilium. This is only configured in the <code>controlplane.yaml</code> file.</p>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln">1</span><span class="cl"><span class="nt">cluster</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w">  </span><span class="nt">proxy</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w">    </span><span class="nt">disabled</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="c"># Disable kube-proxy deployment on cluster bootstrap.</span></span></span></code></pre></div><p>Using <code>talosctl</code>, you can verify that the configuration files are still valid.</p>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">talosctl validate --config controlplane.yaml --mode metal
</span></span><span class="line"><span class="ln">2</span><span class="cl">  controlplane.yaml is valid <span class="k">for</span> metal mode
</span></span><span class="line"><span class="ln">3</span><span class="cl">talosctl validate --config worker.yaml --mode metal
</span></span><span class="line"><span class="ln">4</span><span class="cl">  worker.yaml is valid <span class="k">for</span> metal mode</span></span></code></pre></div><p>The last step is to copy both <code>workload.yaml</code> and <code>controlplane.yaml</code> files to the <code>assets</code> folder on the Matchbox host.</p>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">tree /var/lib/matchbox/
</span></span><span class="line"><span class="ln">2</span><span class="cl">/var/lib/matchbox/
</span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="p">|</span>-- assets
</span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="p">|</span>   <span class="sb">`</span>-- talos
</span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="p">|</span>       <span class="p">|</span>-- controlplane.yaml
</span></span><span class="line"><span class="ln">6</span><span class="cl"><span class="p">|</span>       <span class="sb">`</span>-- worker.yaml</span></span></code></pre></div><h3 id="generate-matchbox-tls-certificate">Generate Matchbox TLS certificate</h3>
<p>Because I&rsquo;m using <a href="https://opentofu.org/">OpenTofu</a> to configure the Matchbox profiles, I need to generate TLS certificates to authenticate with Matchbox gRPC API.</p>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl"><span class="nb">export</span> <span class="nv">SAN</span><span class="o">=</span>DNS.1:matchbox.lan,IP.1:192.168.1.33 <span class="c1">#make sure this match your environment</span></span></span></code></pre></div><p>Run the <a href="https://github.com/poseidon/matchbox/blob/main/scripts/tls/cert-gen">provided script</a> to generate the TLS certificates.</p>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl"><span class="nb">cd</span> scripts/tls
</span></span><span class="line"><span class="ln">2</span><span class="cl">./cert-gen</span></span></code></pre></div><p>Then move the server TLS files to the Matchbox server&rsquo;s default location.</p>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">sudo mkdir -p /etc/matchbox
</span></span><span class="line"><span class="ln">2</span><span class="cl">sudo cp ca.crt server.crt server.key /etc/matchbox
</span></span><span class="line"><span class="ln">3</span><span class="cl">sudo chown -R matchbox:matchbox /etc/matchbox</span></span></code></pre></div><p>Make sure to save the client TLS file for later (<code>client.crt</code>, <code>client.key</code> and <code>ca.crt</code>). They will be required to configure Matchbox with OpenTofu.</p>
<h3 id="create-matchbox-profiles">Create Matchbox profiles</h3>
<p>I will be using <a href="https://opentofu.org/">OpenTofu</a> to create the matchbox profiles using the Matchbox provider and the Talos provider to get the correct schematic ID for the boot assets. The complete code is available <a href="https://codeberg.org/nerkho/tofu-matchbox-config">in this repo</a>.</p>
<p>Start by configuring the provider and copy the client TLS file that you saved earlier to a <code>certs</code> folder alongside the configuration files.</p>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-hcl" data-lang="hcl"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="k">terraform</span> {
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">  <span class="k">required_providers</span> {
</span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="n">    matchbox</span> <span class="o">=</span> {
</span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="n">      source</span>  <span class="o">=</span> <span class="s2">&#34;poseidon/matchbox&#34;</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="n">      version</span> <span class="o">=</span> <span class="s2">&#34;0.5.4&#34;</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">    }
</span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="n">    talos</span> <span class="o">=</span> {
</span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="n">      source</span>  <span class="o">=</span> <span class="s2">&#34;siderolabs/talos&#34;</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="n">      version</span> <span class="o">=</span> <span class="s2">&#34;0.7.0-alpha.0&#34;</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">    }
</span></span><span class="line"><span class="ln">11</span><span class="cl">  }
</span></span><span class="line"><span class="ln">12</span><span class="cl">}
</span></span><span class="line"><span class="ln">13</span><span class="cl">
</span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="k">provider</span> <span class="s2">&#34;matchbox&#34;</span> {
</span></span><span class="line"><span class="ln">15</span><span class="cl"><span class="n">  endpoint</span>    <span class="o">=</span> <span class="s2">&#34;matchbox.lan:8081&#34;</span><span class="c1"> # make sure this match your environment
</span></span></span><span class="line"><span class="ln">16</span><span class="cl"><span class="c1"></span><span class="n">  client_cert</span> <span class="o">=</span> <span class="k">file</span><span class="p">(</span><span class="s2">&#34;certs/client.crt&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">17</span><span class="cl"><span class="n">  client_key</span>  <span class="o">=</span> <span class="k">file</span><span class="p">(</span><span class="s2">&#34;certs/client.key&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="n">  ca</span>          <span class="o">=</span> <span class="k">file</span><span class="p">(</span><span class="s2">&#34;certs/ca.crt&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="ln">19</span><span class="cl">}</span></span></code></pre></div><p>Also add the configuration for the Talos image factory. This will give us the schematic ID for our boot assets.</p>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-terraform" data-lang="terraform"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="kr">data</span> <span class="s2">&#34;talos_image_factory_extensions_versions&#34;</span> <span class="s2">&#34;image_factory&#34;</span> <span class="p">{</span><span class="c1">
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="c1">  # get the latest talos version
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="c1"></span>  <span class="na">talos_version</span> = <span class="nb">var</span><span class="p">.</span><span class="nx">talos_version</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">  <span class="na">filters</span> = <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">    <span class="na">names</span> = <span class="nb">var</span><span class="p">.</span><span class="nx">talos_extensions</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="kr">
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="kr">resource</span> <span class="s2">&#34;talos_image_factory_schematic&#34;</span> <span class="s2">&#34;image_factory&#34;</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl">  <span class="na">schematic</span> =<span class="nb"> yamlencode</span><span class="p">(</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl">      <span class="na">customization</span> = <span class="p">{</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl">        <span class="na">systemExtensions</span> = <span class="p">{</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl">          <span class="na">officialExtensions</span> = <span class="nb">data</span><span class="p">.</span><span class="nx">talos_image_factory_extensions_versions</span><span class="p">.</span><span class="nx">image_factory</span><span class="p">.</span><span class="nx">extensions_info</span><span class="p">.</span><span class="o">*</span><span class="p">.</span><span class="nx">name</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="ln">17</span><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="ln">18</span><span class="cl">  <span class="p">)</span>
</span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="p">}</span></span></span></code></pre></div><p>Create two <code>locals</code> for the boot assets. The cool trick here is to directly point to the Talos image factory. There is no need to save these on the matchbox host.</p>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-terraform" data-lang="terraform"><span class="line"><span class="ln">1</span><span class="cl"><span class="nx">locals</span> <span class="p">{</span>
</span></span><span class="line"><span class="ln">2</span><span class="cl">  <span class="na">kernel</span> = <span class="s2">&#34;https://pxe.factory.talos.dev/image/</span><span class="si">${</span><span class="nx">talos_image_factory_schematic</span><span class="p">.</span><span class="nx">image_factory</span><span class="p">.</span><span class="nx">id</span><span class="si">}</span><span class="s2">/</span><span class="si">${</span><span class="nb">var</span><span class="p">.</span><span class="nx">talos_version</span><span class="si">}</span><span class="s2">/kernel-amd64&#34;</span>
</span></span><span class="line"><span class="ln">3</span><span class="cl">  <span class="na">initrd</span> = <span class="s2">&#34;https://pxe.factory.talos.dev/image/</span><span class="si">${</span><span class="nx">talos_image_factory_schematic</span><span class="p">.</span><span class="nx">image_factory</span><span class="p">.</span><span class="nx">id</span><span class="si">}</span><span class="s2">/</span><span class="si">${</span><span class="nb">var</span><span class="p">.</span><span class="nx">talos_version</span><span class="si">}</span><span class="s2">/initramfs-amd64.xz&#34;</span>
</span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="p">}</span></span></span></code></pre></div><p>Add the matchbox_group and matchbox_profile resource configuration for the controlplane nodes.
The <code>talos.config</code> parameter should matches with the location of the <code>controlplane.yaml</code> file on the Matchbox host. It&rsquo;s this parameter that tells Talos were to find the configuration file for the node.</p>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-hcl" data-lang="hcl"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="k">resource</span> <span class="s2">&#34;matchbox_profile&#34; &#34;controlplane&#34;</span> {
</span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="n">  name</span>   <span class="o">=</span> <span class="s2">&#34;controlplane&#34;</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="n">  kernel</span> <span class="o">=</span> <span class="k">local</span><span class="p">.</span><span class="k">kernel</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="n">  initrd</span> <span class="o">=</span> <span class="p">[</span><span class="k">local</span><span class="p">.</span><span class="k">initrd</span><span class="p">]</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="n">  args</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="n">    &#34;initrd</span><span class="o">=</span><span class="k">initramfs</span><span class="p">.</span><span class="k">xz</span><span class="err">&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="n">    &#34;init_on_alloc</span><span class="o">=</span><span class="m">1</span><span class="err">&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">    <span class="s2">&#34;slab_nomerge&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="n">    &#34;pti</span><span class="o">=</span><span class="k">on</span><span class="err">&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="n">    &#34;console</span><span class="o">=</span><span class="k">tty0</span><span class="err">&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="n">    &#34;console</span><span class="o">=</span><span class="k">ttyS0</span><span class="err">&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="n">    &#34;printk.devkmsg</span><span class="o">=</span><span class="k">on</span><span class="err">&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="n">    &#34;talos.platform</span><span class="o">=</span><span class="k">metal</span><span class="err">&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="n">    &#34;talos.config</span><span class="o">=</span><span class="k">http</span><span class="err">://</span><span class="k">matchbox</span><span class="p">.</span><span class="k">lan</span><span class="err">:</span><span class="m">8080</span><span class="err">/</span><span class="k">assets</span><span class="err">/</span><span class="k">talos</span><span class="err">/</span><span class="k">controlplane</span><span class="p">.</span><span class="k">yaml</span><span class="err">&#34;</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl">  <span class="p">]</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl">}
</span></span><span class="line"><span class="ln">17</span><span class="cl">
</span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="k">resource</span> <span class="s2">&#34;matchbox_group&#34; &#34;controlplane&#34;</span> {
</span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="n">  for_each</span> <span class="o">=</span> <span class="k">var</span><span class="p">.</span><span class="k">controlplanes</span>
</span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="n">  name</span>     <span class="o">=</span> <span class="k">each</span><span class="p">.</span><span class="k">key</span>
</span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="n">  profile</span>  <span class="o">=</span> <span class="k">matchbox_profile</span><span class="p">.</span><span class="k">controlplane</span><span class="p">.</span><span class="k">name</span>
</span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="n">  selector</span> <span class="o">=</span> {
</span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="n">    mac</span> <span class="o">=</span> <span class="k">each</span><span class="p">.</span><span class="k">value</span>
</span></span><span class="line"><span class="ln">24</span><span class="cl">  }
</span></span><span class="line"><span class="ln">25</span><span class="cl">}</span></span></code></pre></div><p>Then simply repeat the same for the worker nodes.</p>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-hcl" data-lang="hcl"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="k">resource</span> <span class="s2">&#34;matchbox_profile&#34; &#34;worker&#34;</span> {
</span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="n">  name</span>   <span class="o">=</span> <span class="s2">&#34;worker&#34;</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="n">  kernel</span> <span class="o">=</span> <span class="k">local</span><span class="p">.</span><span class="k">kernel</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="n">  initrd</span> <span class="o">=</span> <span class="p">[</span><span class="k">local</span><span class="p">.</span><span class="k">initrd</span><span class="p">]</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="n">  args</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="n">    &#34;initrd</span><span class="o">=</span><span class="k">initramfs</span><span class="p">.</span><span class="k">xz</span><span class="err">&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="n">    &#34;init_on_alloc</span><span class="o">=</span><span class="m">1</span><span class="err">&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">    <span class="s2">&#34;slab_nomerge&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="n">    &#34;pti</span><span class="o">=</span><span class="k">on</span><span class="err">&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="n">    &#34;console</span><span class="o">=</span><span class="k">tty0</span><span class="err">&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="n">    &#34;console</span><span class="o">=</span><span class="k">ttyS0</span><span class="err">&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="n">    &#34;printk.devkmsg</span><span class="o">=</span><span class="k">on</span><span class="err">&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="n">    &#34;talos.platform</span><span class="o">=</span><span class="k">metal</span><span class="err">&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="ln">14</span><span class="cl"><span class="n">    &#34;talos.config</span><span class="o">=</span><span class="k">http</span><span class="err">://</span><span class="k">matchbox</span><span class="p">.</span><span class="k">lan</span><span class="err">:</span><span class="m">8080</span><span class="err">/</span><span class="k">assets</span><span class="err">/</span><span class="k">talos</span><span class="err">/</span><span class="k">worker</span><span class="p">.</span><span class="k">yaml</span><span class="err">&#34;</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl">  <span class="p">]</span>
</span></span><span class="line"><span class="ln">16</span><span class="cl">}
</span></span><span class="line"><span class="ln">17</span><span class="cl">
</span></span><span class="line"><span class="ln">18</span><span class="cl"><span class="k">resource</span> <span class="s2">&#34;matchbox_group&#34; &#34;worker&#34;</span> {
</span></span><span class="line"><span class="ln">19</span><span class="cl"><span class="n">  for_each</span> <span class="o">=</span> <span class="k">var</span><span class="p">.</span><span class="k">workers</span>
</span></span><span class="line"><span class="ln">20</span><span class="cl"><span class="n">  name</span>     <span class="o">=</span> <span class="k">each</span><span class="p">.</span><span class="k">key</span>
</span></span><span class="line"><span class="ln">21</span><span class="cl"><span class="n">  profile</span>  <span class="o">=</span> <span class="k">matchbox_profile</span><span class="p">.</span><span class="k">worker</span><span class="p">.</span><span class="k">name</span>
</span></span><span class="line"><span class="ln">22</span><span class="cl"><span class="n">  selector</span> <span class="o">=</span> {
</span></span><span class="line"><span class="ln">23</span><span class="cl"><span class="n">    mac</span> <span class="o">=</span> <span class="k">each</span><span class="p">.</span><span class="k">value</span>
</span></span><span class="line"><span class="ln">24</span><span class="cl">  }
</span></span><span class="line"><span class="ln">25</span><span class="cl">}</span></span></code></pre></div><p>Your *.tfvars file should look something like this with the mac address for each node. This is how Matchbox will determine which profile to use.</p>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-terraform" data-lang="terraform"><span class="line"><span class="ln"> 1</span><span class="cl"><span class="na">talos_version</span>    = <span class="s2">&#34;v1.8.2&#34;</span>
</span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="na">talos_extensions</span> = <span class="p">[</span><span class="s2">&#34;iscsi-tools&#34;</span><span class="p">,</span> <span class="s2">&#34;util-linux-tools&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="na">controlplanes</span> = <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 4</span><span class="cl">  <span class="nx">controlplane</span><span class="o">-</span><span class="na">node01</span> = <span class="s2">&#34;00:00:00:00:00:00&#34;</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl">  <span class="nx">controlplane</span><span class="o">-</span><span class="na">node02</span> = <span class="s2">&#34;00:00:00:00:00:00&#34;</span>
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">  <span class="nx">controlplane</span><span class="o">-</span><span class="na">node03</span> = <span class="s2">&#34;00:00:00:00:00:00&#34;</span>
</span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="na">workers</span> = <span class="p">{</span>
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">  <span class="nx">worker</span><span class="o">-</span><span class="na">node01</span> = <span class="s2">&#34;00:00:00:00:00:00&#34;</span>
</span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="p">}</span></span></span></code></pre></div><p>You can now apply the configuration.</p>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">tofu plan
</span></span><span class="line"><span class="ln">2</span><span class="cl">tofu apply</span></span></code></pre></div><p>If all went well, the groups and profiles will be created on the Matchbox host.</p>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl">tree /var/lib/matchbox/
</span></span><span class="line"><span class="ln"> 2</span><span class="cl">/var/lib/matchbox/
</span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="p">|</span>-- assets
</span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="p">|</span>   <span class="sb">`</span>-- talos
</span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="p">|</span>       <span class="p">|</span>-- controlplane.yaml
</span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="p">|</span>       <span class="sb">`</span>-- worker.yaml
</span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="p">|</span>-- groups
</span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="p">|</span>   <span class="p">|</span>-- controlplane-node01.json
</span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="p">|</span>   <span class="p">|</span>-- controlplane-node02.json
</span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="p">|</span>   <span class="p">|</span>-- controlplane-node03.json
</span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="p">|</span>   <span class="sb">`</span>-- worker-node01.json
</span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="sb">`</span>-- profiles
</span></span><span class="line"><span class="ln">13</span><span class="cl">    <span class="p">|</span>-- controlplane.json
</span></span><span class="line"><span class="ln">14</span><span class="cl">    <span class="sb">`</span>-- worker.json</span></span></code></pre></div><h2 id="bootstrap-the-nodes">Bootstrap the nodes</h2>
<p>This is it! You can now boot your first nodes. If all goes well, it should look similar to this :</p>
<p><img alt="bootstrap" src="/img/homelab-k8s-bootstrap.gif"></p>
<p>Now you can bootstrap your cluster. You only need to run this command once against one of the controlplane node :</p>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">talosctl bootstrap -n 192.168.1.20</span></span></code></pre></div><p>At this point, the other nodes should automatically join the cluster if they are already started.
Once the bootstrapping of all nodes is complete, most of the stuff at the top should come up green. The kubeconfig should automatically be copied to  <code>~/.kube</code> on our system, but it&rsquo;s also possible to retrieve it <code>talosctl kubeconfig -n 192.168.1.20</code>.</p>
<p><img alt="talosdashboard" src="/img/homelab-k8s-talos-dashboard-2.png"></p>
<p>If you disabled <code>kube-proxy</code> earlier, you will notice with <code>kubectl get nodes</code> that the nodes are posting a <code>NotReady</code> state. We still need to deploy Cilium.</p>
<h2 id="cilium">Cilium</h2>
<h3 id="install-cilium">Install Cilium</h3>
<p>The recommended way to install Cilium is with Helm.</p>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln">1</span><span class="cl">helm repo add cilium https://helm.cilium.io/
</span></span><span class="line"><span class="ln">2</span><span class="cl">helm repo update</span></span></code></pre></div><p>Mostly, you can re-use the recommended options from the <a href="https://www.talos.dev/v1.7/kubernetes-guides/network/deploying-cilium/#without-kube-proxy">Talos documentation</a>.</p>
<p>Just add <code>l2announcements.enabled=true</code> as Cilium <a href="https://docs.cilium.io/en/stable/network/l2-announcements/#l2-announcements">L2 announcement feature</a> is required in conjunction with <a href="https://docs.cilium.io/en/stable/network/lb-ipam/">LB IPAM feature</a>. Those 2 options will allow Cilium to automatically assign IP addresses to LoadBalancer type services.</p>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl">helm install <span class="se">\
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="se"></span>    cilium cilium/cilium <span class="se">\
</span></span></span><span class="line"><span class="ln"> 3</span><span class="cl"><span class="se"></span>    --version 1.15.5 <span class="se">\
</span></span></span><span class="line"><span class="ln"> 4</span><span class="cl"><span class="se"></span>    --namespace kube-system <span class="se">\
</span></span></span><span class="line"><span class="ln"> 5</span><span class="cl"><span class="se"></span>    --set ipam.mode<span class="o">=</span>kubernetes <span class="se">\
</span></span></span><span class="line"><span class="ln"> 6</span><span class="cl"><span class="se"></span>    --set<span class="o">=</span><span class="nv">kubeProxyReplacement</span><span class="o">=</span><span class="nb">true</span> <span class="se">\
</span></span></span><span class="line"><span class="ln"> 7</span><span class="cl"><span class="se"></span>    --set<span class="o">=</span>securityContext.capabilities.ciliumAgent<span class="o">=</span><span class="s2">&#34;{CHOWN,KILL,NET_ADMIN,NET_RAW,IPC_LOCK,SYS_ADMIN,SYS_RESOURCE,DAC_OVERRIDE,FOWNER,SETGID,SETUID}&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="ln"> 8</span><span class="cl"><span class="se"></span>    --set<span class="o">=</span>securityContext.capabilities.cleanCiliumState<span class="o">=</span><span class="s2">&#34;{NET_ADMIN,SYS_ADMIN,SYS_RESOURCE}&#34;</span> <span class="se">\
</span></span></span><span class="line"><span class="ln"> 9</span><span class="cl"><span class="se"></span>    --set<span class="o">=</span>cgroup.autoMount.enabled<span class="o">=</span><span class="nb">false</span> <span class="se">\
</span></span></span><span class="line"><span class="ln">10</span><span class="cl"><span class="se"></span>    --set<span class="o">=</span>cgroup.hostRoot<span class="o">=</span>/sys/fs/cgroup <span class="se">\
</span></span></span><span class="line"><span class="ln">11</span><span class="cl"><span class="se"></span>    --set<span class="o">=</span><span class="nv">k8sServiceHost</span><span class="o">=</span>localhost <span class="se">\
</span></span></span><span class="line"><span class="ln">12</span><span class="cl"><span class="se"></span>    --set<span class="o">=</span><span class="nv">k8sServicePort</span><span class="o">=</span><span class="m">7445</span> <span class="se">\
</span></span></span><span class="line"><span class="ln">13</span><span class="cl"><span class="se"></span>    --set<span class="o">=</span>l2announcements.enabled<span class="o">=</span>true</span></span></code></pre></div><p>With <a href="https://github.com/cilium/cilium-cli">cilium-cli</a>, we can easily check the deployment status.</p>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="ln"> 1</span><span class="cl">    /Â¯Â¯<span class="se">\
</span></span></span><span class="line"><span class="ln"> 2</span><span class="cl"><span class="se"></span> /Â¯Â¯<span class="se">\_</span>_/Â¯Â¯<span class="se">\ </span>   Cilium:             OK
</span></span><span class="line"><span class="ln"> 3</span><span class="cl"> <span class="se">\_</span>_/Â¯Â¯<span class="se">\_</span>_/    Operator:           OK
</span></span><span class="line"><span class="ln"> 4</span><span class="cl"> /Â¯Â¯<span class="se">\_</span>_/Â¯Â¯<span class="se">\ </span>   Envoy DaemonSet:    disabled <span class="o">(</span>using embedded mode<span class="o">)</span>
</span></span><span class="line"><span class="ln"> 5</span><span class="cl"> <span class="se">\_</span>_/Â¯Â¯<span class="se">\_</span>_/    Hubble Relay:       disabled
</span></span><span class="line"><span class="ln"> 6</span><span class="cl">    <span class="se">\_</span>_/       ClusterMesh:        disabled
</span></span><span class="line"><span class="ln"> 7</span><span class="cl">
</span></span><span class="line"><span class="ln"> 8</span><span class="cl">Deployment             cilium-operator    Desired: 2, Ready: 2/2, Available: 2/2
</span></span><span class="line"><span class="ln"> 9</span><span class="cl">DaemonSet              cilium             Desired: 4, Ready: 4/4, Available: 4/4
</span></span><span class="line"><span class="ln">10</span><span class="cl">Containers:            cilium             Running: <span class="m">4</span>
</span></span><span class="line"><span class="ln">11</span><span class="cl">                       cilium-operator    Running: <span class="m">2</span>
</span></span><span class="line"><span class="ln">12</span><span class="cl">Cluster Pods:          75/75 managed by Cilium
</span></span><span class="line"><span class="ln">13</span><span class="cl">Helm chart version:
</span></span><span class="line"><span class="ln">14</span><span class="cl">Image versions         cilium             quay.io/cilium/cilium:v1.15.5@sha256:4ce1666a73815101ec9a4d360af6c5b7f1193ab00d89b7124f8505dee147ca40: <span class="m">4</span>
</span></span><span class="line"><span class="ln">15</span><span class="cl">                       cilium-operator    quay.io/cilium/operator-generic:v1.15.5@sha256:f5d3d19754074ca052be6aac5d1ffb1de1eb5f2d947222b5f10f6d97ad4383e8: <span class="m">2</span></span></span></code></pre></div><p>Once everything is green, the Kubernetes nodes should also post a <code>Ready</code> state.</p>
<h3 id="enable-l2-announcement-and-lb-ipam-features">Enable L2 announcement and LB IPAM features</h3>
<p>This is quite straight forward.</p>
<p>Define an IP address pool :</p>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln">1</span><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;cilium.io/v2alpha1&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">CiliumLoadBalancerIPPool</span><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;my-pool&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">6</span><span class="cl"><span class="w">  </span><span class="nt">cidrs</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">7</span><span class="cl"><span class="w">  </span>- <span class="nt">start</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;192.168.1.60&#34;</span><span class="w">
</span></span></span><span class="line"><span class="ln">8</span><span class="cl"><span class="w">    </span><span class="nt">stop</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;192.168.1.99&#34;</span></span></span></code></pre></div><p>Create a L2 announcement policy :</p>





<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="ln">1</span><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">cilium.io/v2alpha1</span><span class="w">
</span></span></span><span class="line"><span class="ln">2</span><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">CiliumL2AnnouncementPolicy</span><span class="w">
</span></span></span><span class="line"><span class="ln">3</span><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">4</span><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">default-l2-announcement-policy</span><span class="w">
</span></span></span><span class="line"><span class="ln">5</span><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">kube-system</span><span class="w">
</span></span></span><span class="line"><span class="ln">6</span><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="ln">7</span><span class="cl"><span class="w">  </span><span class="nt">externalIPs</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="ln">8</span><span class="cl"><span class="w">  </span><span class="nt">loadBalancerIPs</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span></span></span></code></pre></div><p>Now, whenever you create a LoadBalancer service type, it should automatically get an IP address assigned from the defined address pool and the service will be reachable from outside the cluster.</p>
<h2 id="conclusion">Conclusion</h2>
<p>I see various way this setup could be improved, but in general, I think it is a nice starting point for K8s homelab cluster with Talos. I hope this was helpful to someone out there :)</p>

</content>
<p>
  
    <a class="blog-tags" href="/tags/kubernetes/">#kubernetes</a>
  
    <a class="blog-tags" href="/tags/talos/">#talos</a>
  
    <a class="blog-tags" href="/tags/cilium/">#cilium</a>
  
    <a class="blog-tags" href="/tags/homelab/">#homelab</a>
  
</p>


  <p>
    <a href='mailto:nerkho@pm.me?subject=Reply%20to%20"Homelab%20Kubernetes%20cluster%20with%20Talos%2c%20Matchbox%20and%20Cilium"'>
      Reply to this post by email â†ª
    </a>
  </p>



  </main>
  <footer><small>
  nerkho (CC BY 4.0) | Made with <a href="https://github.com/clente/hugo-bearcub">Bear Cub</a>
</small></footer>

    
</body>

</html>
